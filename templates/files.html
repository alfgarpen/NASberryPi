{% extends "layout.html" %}
{% block title %}File Manager{% endblock %}

{% block content %}

{# ── Top Navigation: My Files / Shared Folder ── #}
<div class="card" style="padding: 0.75rem 1.25rem; margin-bottom: 1rem;">
    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
        <span style="font-weight: 600; color: #495057; margin-right: 0.5rem;">
            <i class="fas fa-compass"></i> Navigate:
        </span>

        {# My Files button #}
        {% set my_files_style = '' if current_path.startswith(user_home_rel) else 'background:#e9ecef; color:#495057;'
        %}
        <a href="{{ url_for('files', req_path=user_home_rel) }}"
            class="btn btn-sm {% if current_path.startswith(user_home_rel) %}btn-primary{% endif %}"
            style="{{ my_files_style }}">
            <i class="fas fa-home"></i> My Files
        </a>

        {# Shared Folder button – behaviour depends on access status #}
        {% if shared_access and shared_access.status == 'approved' %}
        {% set shared_style = '' if current_path.startswith('shared') else 'background:#e9ecef; color:#495057;' %}
        <a href="{{ url_for('files', req_path='shared') }}"
            class="btn btn-sm {% if current_path.startswith('shared') %}btn-success{% endif %}"
            style="{{ shared_style }}">
            <i class="fas fa-folder-open"></i> Shared Folder
        </a>
        {% elif shared_access and shared_access.status == 'pending' %}
        <span class="btn btn-sm" style="background:#fff3cd; color:#856404; cursor:default;"
            title="Your access request is pending admin approval.">
            <i class="fas fa-clock"></i> Shared Folder
            <span class="badge"
                style="background:#856404; color:white; font-size:0.7rem; margin-left:4px;">Pending</span>
        </span>
        {% elif shared_access and shared_access.status == 'rejected' %}
        <span class="btn btn-sm" style="background:#f8d7da; color:#721c24; cursor:default;"
            title="Your access request was rejected.">
            <i class="fas fa-ban"></i> Shared Folder
            <span class="badge"
                style="background:#721c24; color:white; font-size:0.7rem; margin-left:4px;">Denied</span>
        </span>
        {% elif session.get('role') != 'admin' %}
        <form action="{{ url_for('request_shared_access') }}" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-sm" style="background:#e9ecef; color:#495057;"
                title="Request access to the shared folder">
                <i class="fas fa-folder-plus"></i> Shared Folder
                <span class="badge"
                    style="background:#6c757d; color:white; font-size:0.7rem; margin-left:4px;">Request</span>
            </button>
        </form>
        {% endif %}
    </div>
</div>

{# ── File Actions Bar ── #}
<div class="card">
    <div class="file-actions">
        <form action="{{ url_for('file_action') }}" method="POST" enctype="multipart/form-data"
            style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="hidden" name="action" value="upload">
            <input type="hidden" name="current_path" value="{{ current_path }}">
            <input type="file" name="file" required style="border: 1px solid var(--border-color); padding: 0.25rem;">
            <button type="submit" class="btn btn-sm"><i class="fas fa-upload"></i> Upload</button>
        </form>

        <div style="width: 1px; background: #dee2e6; height: 30px; margin: 0 0.5rem;"></div>

        <form action="{{ url_for('file_action') }}" method="POST" style="display: flex; gap: 0.5rem;">
            <input type="hidden" name="action" value="create_folder">
            <input type="hidden" name="current_path" value="{{ current_path }}">
            <input type="text" name="folder_name" placeholder="New Folder Name" required class="form-control"
                style="width: 150px; padding: 0.25rem;">
            <button type="submit" class="btn btn-sm"><i class="fas fa-folder-plus"></i> Create</button>
        </form>
    </div>

    {# ── Breadcrumb ── #}
    <div class="breadcrumb">
        <a href="{{ url_for('files', req_path=user_root_rel) }}"><i class="fas fa-home"></i> Root</a>
        {% if current_path %}
        {% set parts = current_path.split('/') %}
        {% set ns = namespace(path='') %}
        {% for part in parts %}
        {% set ns.path = ns.path + part + '/' %}
        <span>/</span>
        <a href="{{ url_for('files', req_path=ns.path.rstrip('/')) }}">{{ part }}</a>
        {% endfor %}
        {% endif %}
    </div>

    {# ── File Table ── #}
    <table>
        <thead>
            <tr>
                <th style="width: 50px;">Type</th>
                <th>Name</th>
                <th style="width: 100px;">Size</th>
                <th style="width: 150px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if parent_path is not none %}
            <tr>
                <td><i class="fas fa-level-up-alt file-icon dir-icon"></i></td>
                <td><a href="{{ url_for('files', req_path=parent_path) }}">..</a></td>
                <td>-</td>
                <td></td>
            </tr>
            {% endif %}

            {% for file in files %}
            <tr>
                <td>
                    {% if file.is_dir %}
                    <i class="fas fa-folder file-icon dir-icon"></i>
                    {% else %}
                    <i class="fas fa-file file-icon file-icon-default"></i>
                    {% endif %}
                </td>
                <td>
                    {% if file.is_dir %}
                    <a href="{{ url_for('files', req_path=file.path) }}">{{ file.name }}</a>
                    {% else %}
                    <a href="{{ url_for('files', req_path=file.path) }}" target="_blank">{{ file.name }}</a>
                    {% endif %}
                </td>
                <td>{{ file.size }}</td>
                <td>
                    <div style="display: flex; gap: 0.25rem;">
                        <button onclick="promptRename('{{ file.name }}')" class="btn btn-sm"
                            style="background: #17a2b8;" title="Rename">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form action="{{ url_for('file_action') }}" method="POST"
                            onsubmit="return confirm('Delete {{ file.name }}?');" style="display: inline;">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="current_path" value="{{ current_path }}">
                            <input type="hidden" name="item_name" value="{{ file.name }}">
                            <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" style="text-align: center; color: #6c757d;">Folder is empty</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# Hidden rename form #}
<form id="renameForm" action="{{ url_for('file_action') }}" method="POST" style="display: none;">
    <input type="hidden" name="action" value="rename">
    <input type="hidden" name="current_path" value="{{ current_path }}">
    <input type="hidden" name="old_name" id="renameOldName">
    <input type="hidden" name="new_name" id="renameNewName">
</form>

<script>
    function promptRename(oldName) {
        const newName = prompt("Enter new name for " + oldName + ":", oldName);
        if (newName && newName !== oldName) {
            document.getElementById('renameOldName').value = oldName;
            document.getElementById('renameNewName').value = newName;
            document.getElementById('renameForm').submit();
        }
    }
</script>
{% endblock %}